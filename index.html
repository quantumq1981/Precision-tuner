<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scale & Mode Practice Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            'root-note': '#10b981', // Emerald 500 (Green)
            'scale-note': '#000000', // Black
            'note-highlight': '#f59e0b', // Amber 500 (Gold)
            'fretboard-wood': '#6e4e3e',
          }
        }
      }
    }
  </script>
  <!-- Custom styles for SVG elements, using CSS variables for colors -->
  <style>
    :root {
      --root-note: #10b981;
      --scale-note: #000000;
      --fret-mark: #374151;
      --note-highlight: #f59e0b;
    }

    .fretboard-container {
      overflow-x: auto;
      max-width: 100%;
      /* Mobile Scrolling Enhancements */
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory; 
      /* Hide scrollbar on mobile devices */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* Internet Explorer 10+ */
    }
    .fretboard-container::-webkit-scrollbar { 
        display: none; /* Chrome, Safari, Opera */
    }

    .string { stroke: #e5e5e5; stroke-width: 2; }
    .fret { stroke: #888; stroke-width: 2; }
    .nut { stroke: var(--fret-mark); stroke-width: 5; }
    .note-circle { fill: var(--scale-note); transition: all 0.1s; cursor: pointer; }
    .root-circle { fill: var(--root-note); transition: all 0.1s; cursor: pointer; }
    .highlight-circle { fill: var(--note-highlight); transition: all 0.1s; }
    .note-label { fill: white; pointer-events: none; }
    .fret-dot { fill: var(--fret-mark); }

    th, td { border: 1px solid #e5e7eb; padding: 6px 8px; }

    /* Custom Switch Styling for Scale Degree Toggle */
    .toggle-checkbox:checked + .toggle-label {
      background-color: #4f46e5;
    }
    .toggle-checkbox:checked + .toggle-label::after {
      transform: translateX(100%);
    }
    .toggle-label::after {
        content: '';
        position: absolute;
        left: 4px;
        top: 4px;
        width: 12px;
        height: 12px; 
        background-color: white;
        border-radius: 9999px;
        transition: transform 0.2s;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 p-4 sm:p-6">

  <div class="max-w-5xl mx-auto space-y-8">

    <header class="text-center py-6 bg-white shadow-xl rounded-xl">
      <h1 class="text-3xl font-extrabold text-indigo-700">Fretboard Scale & Mode Visualizer</h1>
      <p class="text-sm text-gray-500 mt-1">Enharmonic control, voicing highlights, and interactive note playback.</p>
    </header>

    <!-- SECTION 1: Tool Interface -->
    <div class="bg-white p-6 shadow-xl rounded-xl space-y-4">
      <h2 class="text-xl font-bold border-b pb-2 text-gray-700">1. Select and Visualize Scale</h2>

      <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
        
        <!-- Scale Type -->
        <div>
          <label for="typeSelect" class="block text-sm font-medium text-gray-600 mb-1">Scale Type:</label>
          <select id="typeSelect" aria-label="Scale Type" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <option value="mode">Diatonic Modes (Major Derived)</option>
            <option value="harmonic">Harmonic Minor Modes</option>
            <option value="melodic">Melodic Minor Modes</option>
            <option value="pentatonic">Pentatonic</option>
            <option value="diminished">Diminished/Symmetrical</option>
            <option value="extended">Extended / Exotic</option>
          </select>
        </div>
        
        <!-- Scale Choice -->
        <div class="col-span-2">
          <label for="choiceSelect" class="block text-sm font-medium text-gray-600 mb-1">Scale/Mode Choice:</label>
          <select id="choiceSelect" aria-label="Scale Choice" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <!-- options populated dynamically -->
          </select>
        </div>
        
        <!-- Root Note -->
        <div>
          <label for="rootSelect" class="block text-sm font-medium text-gray-600 mb-1">Root Note (Tonic):</label>
          <select id="rootSelect" aria-label="Root Note" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <!-- options populated dynamically by JS on load -->
          </select>
        </div>
        
        <!-- Notation Select (Flats/Sharps Toggle) -->
        <div>
          <label for="notationSelect" class="block text-sm font-medium text-gray-600 mb-1">Notation:</label>
          <select id="notationSelect" aria-label="Note Notation Preference" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <option value="sharp" selected>Sharps (C#)</option>
            <option value="flat">Flats (Db)</option>
          </select>
        </div>

        <!-- Scale Degree Toggle -->
        <div class="flex flex-col items-center justify-center pt-2">
            <span class="block text-sm font-medium text-gray-600 mb-1">Label Mode:</span>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="degreeToggle" class="hidden toggle-checkbox">
                <label for="degreeToggle" class="relative block w-10 h-6 cursor-pointer rounded-full bg-gray-300 transition-colors duration-200 ease-in-out toggle-label">
                    <!-- Toggle circle handled by CSS ::after -->
                </label>
                <span class="text-xs font-medium text-gray-700 select-none">Degrees (R, b3)</span>
            </div>
        </div>

      </div>

      <!-- Action Buttons -->
      <div class="flex gap-4 pt-2">
        <button id="showScaleBtn" class="flex-1 py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
          Show Scale & Chords
        </button>
        <button id="playScaleBtn" class="w-2/5 md:w-1/5 py-2 px-4 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-offset-2 transition duration-150 ease-in-out">
          ▶️ Play Scale
        </button>
      </div>


      <!-- Scale Notes Display -->
      <div id="scaleNotes" aria-live="polite" class="mt-4 p-3 bg-indigo-50 text-indigo-800 rounded-lg font-mono text-center text-sm sm:text-base">
        Select a scale type, choice, and root note above.
      </div>
      
      <!-- Scale Formula Breakdown -->
      <div id="scaleAnalysis" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm space-y-2" aria-live="polite">
        <!-- Analysis will be displayed here -->
      </div>


      <!-- Fretboard Area -->
      <div id="fretboard" class="fretboard-container bg-fretboard-wood rounded-lg shadow-inner border-2 border-gray-900">
        <!-- SVG will be drawn here -->
      </div>
    </div>

    <!-- SECTION 2: Diatonic Chords & Voicings -->
    <div class="bg-white p-6 shadow-xl rounded-xl">
      <h2 class="text-xl font-bold border-b pb-2 text-gray-700">2. Diatonic Chords and Voicings</h2>
      <p class="text-sm text-gray-500 mt-2">Click on any voicing string (e.g., <code class="bg-gray-100 px-1 rounded text-xs">x35353</code>) to see the finger position highlighted in <strong>red</strong> on the fretboard. Click any note circle to hear it and highlight it in <strong>gold</strong> across the board.</p>
      
      <div id="chordOutput" class="mt-4" aria-live="polite">
        <!-- Chord table will be populated here -->
      </div>
      <p id="chordError" class="mt-4 text-red-600 font-semibold hidden">This scale type does not generate standard diatonic 7th chords (e.g., pentatonic, hexatonic scales).</p>
    </div>
  </div>

  <script>
    // --- Global State ---
    let currentVoicingHighlight = null;
    let currentNoteHighlight = null;
    
    // --- Musical Data Structures ---
    
    // Enharmonic Note Map (Internal Canonical 0-11)
    const noteMap = [
      { sharp: "C", flat: "C", index: 0 },
      { sharp: "C#", flat: "Db", index: 1 },
      { sharp: "D", flat: "D", index: 2 },
      { sharp: "D#", flat: "Eb", index: 3 },
      { sharp: "E", flat: "E", index: 4 },
      { sharp: "F", flat: "F", index: 5 },
      { sharp: "F#", flat: "Gb", index: 6 },
      { sharp: "G", flat: "G", index: 7 },
      { sharp: "G#", flat: "Ab", index: 8 },
      { sharp: "A", flat: "A", index: 9 },
      { sharp: "A#", flat: "Bb", index: 10 },
      { sharp: "B", flat: "B", index: 11 },
    ];
    
    const svgNS = "http://www.w3.org/2000/svg";

    // --- Helper Functions for Notes ---
    function getNoteName(index, notation) {
      return noteMap[index % 12][notation];
    }

    function getNoteIndex(noteStr) {
      const found = noteMap.find(n => n.sharp === noteStr || n.flat === noteStr);
      return found ? found.index : -1;
    }

    // List of all possible root notes for the dropdown
    const allRootNotes = noteMap.map(n => n.sharp);

    // --- Audio Playback Functions (Web Audio API) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    function initAudioContext() {
      if (!audioCtx) {
        audioCtx = new AudioContext();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(e => console.error("AudioContext resume failed:", e));
      }
      return audioCtx;
    }
    
    function getFrequency(noteName) {
      // Mapping from C4 (index 0) to standard frequency
      const freqMap = {
        "C": 261.63, "C#": 277.18, "Db": 277.18,
        "D": 293.66, "D#": 311.13, "Eb": 311.13,
        "E": 329.63, "F": 349.23, "F#": 369.99, "Gb": 369.99,
        "G": 392.00, "G#": 415.30, "Ab": 415.30,
        "A": 440.00, "A#": 466.16, "Bb": 466.16,
        "B": 493.88
      };
      // Simple octave shift for lower notes
      return freqMap[noteName] ? freqMap[noteName] / 2 : 0; 
    }

    function playNote(noteName, duration = 0.3, delay = 0) {
      try {
        const context = initAudioContext();
        const freq = getFrequency(noteName);
        if (freq === 0) return;

        const osc = context.createOscillator();
        const gain = context.createGain();

        osc.frequency.setValueAtTime(freq, context.currentTime + delay);
        osc.type = "sine"; 
        
        gain.gain.setValueAtTime(0, context.currentTime + delay);
        gain.gain.linearRampToValueAtTime(0.3, context.currentTime + delay + 0.05); 
        gain.gain.linearRampToValueAtTime(0.15, context.currentTime + delay + 0.15); 
        gain.gain.linearRampToValueAtTime(0, context.currentTime + delay + duration); 

        osc.connect(gain).connect(context.destination);
        osc.start(context.currentTime + delay);
        osc.stop(context.currentTime + delay + duration);
      } catch (error) {
        console.error("Error playing note:", error);
      }
    }
    
    function playScale(scaleNotes) {
        let delay = 0;
        scaleNotes.forEach(note => {
            playNote(note, 0.25, delay);
            delay += 0.3;
        });
    }

    // --- Scale Definitions (unchanged) ---
    const modes = {
      Ionian: ["1","2","3","4","5","6","7"],
      Dorian: ["1","2","b3","4","5","6","b7"],
      Phrygian: ["1","b2","b3","4","5","b6","b7"],
      Lydian: ["1","2","3","#4","5","6","7"],
      Mixolydian: ["1","2","3","4","5","6","b7"],
      Aeolian: ["1","2","b3","4","5","b6","b7"],
      Locrian: ["1","b2","b3","4","b5","b6","b7"]
    };

    const harmonicMinorModes = {
        "Harmonic Minor": ["1", "2", "b3", "4", "5", "b6", "7"],
        "Phrygian Dominant": ["1", "b2", "3", "4", "5", "b6", "b7"],
        "Locrian ♮6": ["1", "b2", "b3", "4", "b5", "6", "b7"],
        "Ionian ♯5": ["1", "2", "3", "4", "#5", "6", "7"],
    };

    const melodicMinorModes = {
        "Melodic Minor (Asc)": ["1", "2", "b3", "4", "5", "6", "7"],
        "Altered (Super Locrian)": ["1", "b2", "b3", "b4", "b5", "b6", "b7"],
        "Lydian Dominant": ["1", "2", "3", "#4", "5", "6", "b7"],
        "Mixolydian ♭6": ["1", "2", "3", "4", "5", "b6", "b7"],
    };

    const pentatonics = {
      "Major Pentatonic": ["1","2","3","5","6"],
      "Minor Pentatonic": ["1","b3","4","5","b7"],
      "Blues (Hexatonic)": ["1", "b3", "4", "#4", "5", "b7"] 
    };

    const diminishedScales = {
      "Whole-Half Diminished": ["1","2","b3","4","b5","b6","6","7"],
      "Half-Whole Diminished": ["1","b2","b3","3","b5","5","6","b7"],
    };

    const extendedScales = {
      "Bebop Major (Octatonic)": ["1", "2", "3", "4", "5", "6", "b7", "7"],
      "Harmonic Major": ["1", "2", "3", "4", "5", "b6", "7"],
      "Double Harmonic (Byzantine)": ["1", "b2", "3", "4", "5", "b6", "7"],
      "Whole Tone (Hexatonic)": ["1", "2", "3", "#4", "#5", "b7"]
    };

    const scaleTypes = {
      mode: modes,
      harmonic: harmonicMinorModes,
      melodic: melodicMinorModes,
      pentatonic: pentatonics,
      diminished: diminishedScales,
      extended: extendedScales
    };
    
    /* ---------- VOICING LIBRARY ---------- */
    const voicingLibrary = {
      "Maj7": ["x32000","x02120","879987"], 
      "m7": ["x02010","575555","8108988"],
      "7": ["320001","x02023","81089108"],
      "m7b5": ["x2323x","353433","78787x"],
      "dim7": ["x3453x","xx2313","678678"],
      "dim": ["x3424x","xx3454"],
      "aug": ["x3210x","332110"],
      "sus4": ["x33011","330011"],
      "Maj7#5": ["x0214x","766887"],
      "7b9": ["x02023","x2123x","767767"],
      "7#9": ["x7677x","767877"],
      "7b13": ["x02023","656656"],
      "sus2": ["x02200","779977"],
      "alt": ["x7676x","767676"], 
      "add9": ["x02400","799977"],
      "Maj7#11": ["x0212x","765877"]
    };

    /* ---------- SCALE CHORD SUGGESTIONS ---------- */
    const scaleChordSuggestions = {
      "Whole-Half Diminished": [
        { chord: "dim7", label: "Fully diminished 7 (symmetrical stack of minor 3rds). Great as a tonic/mediant color.", voicings: voicingLibrary["dim7"] || [] },
        { chord: "m7b5", label: "Half-diminished (use on iiø of minor-ish contexts).", voicings: voicingLibrary["m7b5"] || [] },
        { chord: "7b9", label: "Dominant with ♭9 tensions — color over dominant-function passages.", voicings: voicingLibrary["7b9"] || [] },
        { chord: "alt", label: "Altered dominant clusters — use for resolving tensions.", voicings: voicingLibrary["alt"] || [] }
      ],
      "Half-Whole Diminished": [
        { chord: "dim7", label: "Diminished clusters; symmetric diminished arpeggios work well.", voicings: voicingLibrary["dim7"] || [] },
        { chord: "7#9", label: "Dominant with #9 color — commonly used over diminished-derived dominants.", voicings: voicingLibrary["7#9"] || [] },
        { chord: "7b13", label: "Dominant with lowered 13 for dark color.", voicings: voicingLibrary["7b13"] || [] }
      ],
      "Whole Tone (Hexatonic)": [
        { chord: "7#5", label: "Dominant with augmented 5th (whole-tone pool), invokes dream/floaty dominant.", voicings: voicingLibrary["Maj7#5"] || [] },
        { chord: "7#11", label: "Dominant with #11 (augmented 4) — altered Lydian dominant colors.", voicings: voicingLibrary["Maj7#11"] || [] },
        { chord: "aug", label: "Augmented triads/arpeggios sit naturally.", voicings: voicingLibrary["aug"] || [] }
      ],
      "Bebop Major (Octatonic)": [
        { chord: "Maj7", label: "Major tonic with chromatic passing (bebop flavor).", voicings: voicingLibrary["Maj7"] || [] },
        { chord: "7", label: "Dominant sounds on V — use 9/13 tension voicings.", voicings: voicingLibrary["7"] || [] }
      ],
      "Harmonic Major": [
        { chord: "Maj7", label: "Major tonic with lowered 6th color (Maj7(b6) implication).", voicings: voicingLibrary["Maj7"] || [] },
        { chord: "7b9", label: "Dominant with exotic b9 colors (fit for V that uses harmonic major).", voicings: voicingLibrary["7b9"] || [] }
      ],
      "Double Harmonic (Byzantine)": [
        { chord: "Maj7#11", label: "Major tonic with #11 / augmented flavor & exotic step (b2 color).", voicings: voicingLibrary["Maj7#11"] || [] },
        { chord: "7b9", label: "Dominant with strong b9 flavor (phrygian-ish dominants).", voicings: voicingLibrary["7b9"] || [] }
      ],
      "Blues (Hexatonic)": [
        { chord: "m7", label: "Minor pentatonic/blues over a minor tonic.", voicings: voicingLibrary["m7"] || [] },
        { chord: "7", label: "Dominant blues color for V/turnarounds.", voicings: voicingLibrary["7"] || [] }
      ],
      "Major Pentatonic": [
        { chord: "Maj7", label: "Major tonic (I) - great for simple folk or rock.", voicings: voicingLibrary["Maj7"] || [] },
        { chord: "7", label: "Dominant (V) - common rock/blues color.", voicings: voicingLibrary["7"] || [] }
      ],
      "Minor Pentatonic": [
        { chord: "m7", label: "Minor tonic (i) - classic rock/blues minor sound.", voicings: voicingLibrary["m7"] || [] },
        { chord: "7", label: "Dominant (V) - common rock/blues color.", voicings: voicingLibrary["7"] || [] }
      ]
    };


    // --- Architectural Improvement: Robust Interval Parsing ---
    function intervalToSemitone(intervalStr) {
      const baseIntervals = { '1': 0, '2': 2, '3': 4, '4': 5, '5': 7, '6': 9, '7': 11, '8': 12 }; 
      
      const numMatch = intervalStr.match(/[1-8]/);
      if (!numMatch) return 0;
      const num = numMatch[0];
      const acc = intervalStr.replace(num, '');

      let semitones = baseIntervals[num] || 0;

      if (acc.includes('b')) semitones -= acc.match(/b/g).length;
      if (acc.includes('#')) semitones += acc.match(/#/g).length;
      
      return (semitones % 12 + 12) % 12;
    }

    // Function to get the full name of an interval based on semitone offset
    function getIntervalNameFromSemitone(semitone) {
        // This is a common interval naming convention (e.g., 3 is minor 3rd, 4 is Major 3rd)
        const intervalMap = {
            0: 'Root (1)', 1: 'm2/♭9', 2: 'M2/9', 3: 'm3/♭10', 4: 'M3/10',
            5: 'P4/11', 6: 'A4/#11', 7: 'P5', 8: 'A5/♭13', 9: 'M6/13',
            10: 'm7/♭14', 11: 'M7/14'
        };
        return intervalMap[semitone % 12] || 'N/A';
    }

    function calculateWHTrail(intervals) {
        if (!intervals || intervals.length === 0) return 'N/A';
        
        const semitones = intervals.map(intervalToSemitone); 
        const steps = [];
        let prevSemitone = 0;
        
        for (let i = 0; i < semitones.length; i++) {
            const currentSemitone = semitones[i];
            
            let diff = currentSemitone - prevSemitone;
            if (i > 0) { 
                steps.push(diff);
            }
            prevSemitone = currentSemitone;
        }

        const lastStep = 12 - prevSemitone;
        if (lastStep > 0 && lastStep !== 12) { 
             steps.push(lastStep);
        }
        
        return steps.map(step => {
            if (step === 1) return 'H'; 
            if (step === 2) return 'W'; 
            if (step === 3) return 'W+H';
            return 'X'; 
        }).join(' – ');
    }

    function getScaleDerivation(type, choice, root) {
        if (type === 'mode') {
            const degrees = { Ionian: "1st", Dorian: "2nd", Phrygian: "3rd", Lydian: "4th", Mixolydian: "5th", Aeolian: "6th", Locrian: "7th" };
            const degreeOffset = { Ionian: 0, Dorian: 2, Phrygian: 4, Lydian: 5, Mixolydian: 7, Aeolian: 9, Locrian: 11 };
            const modeInterval = degreeOffset[choice];
            const majorRootIndex = (getNoteIndex(root) - modeInterval + 12) % 12; 
            const majorRootName = getNoteName(majorRootIndex, 'sharp'); 
            
            return `This mode is derived from the <strong>${majorRootName} Major</strong> scale (Ionian), starting on its <strong>${degrees[choice]}</strong> degree.`;
        }
        if (choice.includes("Pentatonic") || choice.includes("Blues")) {
            return `A scale focused on consonance. The Major Pentatonic is a Major scale (Ionian) with the 4th and 7th degrees removed.`;
        }
        if (choice === "Harmonic Minor") {
            const naturalMinorRoot = root;
            const naturalMinor7th = getNoteName((getNoteIndex(root) + 10) % 12, 'flat'); 
            const raised7th = getNoteName((getNoteIndex(root) + 11) % 12, 'sharp'); 
            return `Built from the <strong>${naturalMinorRoot} Natural Minor</strong> scale by raising the <strong>7th degree</strong> (${naturalMinor7th}) by a half-step to <strong>${raised7th}</strong>.`;
        }
        if (choice === "Melodic Minor (Asc)") {
             return `The Melodic Minor scale is built from Natural Minor by raising both the <strong>6th and 7th degrees</strong> by a half-step.`;
        }
        const intervals = scaleTypes[type]?.[choice] || [];
        return `The <strong>${choice}</strong> is a unique scale characterized by its specific interval formula: <strong>${intervals.join("-")}</strong>.`;
    }

    function buildScale(root, intervals) {
      const notation = document.getElementById("notationSelect").value;
      const rootIdx = getNoteIndex(root);
      if (rootIdx === -1) return { scaleNotes: [], intervals: [] };
      
      const scaleNotes = intervals.map(iv => {
        const offs = intervalToSemitone(iv);
        return getNoteName((rootIdx + offs) % 12, notation);
      });
      return { scaleNotes, intervals };
    }

    // --- DOM Elements and Handlers ---
    const typeSelect = document.getElementById("typeSelect");
    const choiceSelect = document.getElementById("choiceSelect");
    const rootSelect = document.getElementById("rootSelect");
    const notationSelect = document.getElementById("notationSelect");
    const degreeToggle = document.getElementById("degreeToggle");
    const showScaleBtn = document.getElementById("showScaleBtn");
    const playScaleBtn = document.getElementById("playScaleBtn");
    const chordOutputDiv = document.getElementById("chordOutput");
    const chordErrorP = document.getElementById("chordError");
    const scaleAnalysisDiv = document.getElementById("scaleAnalysis"); 

    function populateRootSelect() {
        allRootNotes.forEach(note => {
            const opt = document.createElement("option");
            opt.value = note;
            opt.textContent = note;
            rootSelect.appendChild(opt);
        });
    }

    function updateChoices() {
      choiceSelect.innerHTML = "";
      const selectedType = typeSelect.value;
      const obj = scaleTypes[selectedType];
      for (const name in obj) {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        choiceSelect.appendChild(opt);
      }
      if (rootSelect.value) {
        showScaleBtn.click();
      }
    }
    
    // --- Fretboard Click Handlers ---

    function createSVGElement(tag, attrs = {}) {
      const el = document.createElementNS(svgNS, tag);
      for (const [key, val] of Object.entries(attrs)) {
        el.setAttribute(key, val);
      }
      return el;
    }

    function clearVoicingHighlights() {
        document.querySelectorAll('.voicing-highlight').forEach(el => el.remove());
        currentVoicingHighlight = null;
    }
    
    function highlightVoicing(voicingString) {
        if (currentVoicingHighlight === voicingString) {
            clearVoicingHighlights();
            drawFretboard(getScaleData().scaleNotes, getScaleData().root, getScaleData().intervals, getScaleData().choice);
            return;
        }

        currentVoicingHighlight = voicingString;
        currentNoteHighlight = null; // Clear individual note highlight

        drawFretboard(getScaleData().scaleNotes, getScaleData().root, getScaleData().intervals, getScaleData().choice);

        // Get SVG element
        const svg = document.getElementById("fretboard").querySelector('svg');
        if (!svg || voicingString.length !== 6) return;

        // Fretboard constants (must match drawFretboard)
        const strings = ["E","B","G","D","A","E"]; 
        const numFrets = 15;
        const width = 1000;
        const height = 180;
        const margin = { left: 40, top: 20, right: 20, bottom: 20 };
        const drawingWidth = width - margin.left - margin.right;
        const fretSpacing = drawingWidth / (numFrets + 0.5);
        const stringSpacing = (height - margin.top - margin.bottom) / (strings.length - 1);

        // Process voicing string (Low E is index 0 to High e is index 5)
        for (let i = 0; i < 6; i++) {
            const fretChar = voicingString[i]; 

            if (fretChar === 'x' || fretChar === 'X') continue;
            
            const f = parseInt(fretChar, 10);
            if (isNaN(f)) continue;

            let cx = f === 0 
                ? margin.left - fretSpacing / 2 
                : margin.left + f * fretSpacing - fretSpacing / 2;
                
            const stringIndex = (strings.length - 1) - i; // map Low E (i=0) to bottom string (index 5)
            const cy = margin.top + stringIndex * stringSpacing;

            const r = 10;
            
            const highlightCircle = createSVGElement("circle", {
                cx: cx, cy: cy, r: r,
                class: "voicing-highlight",
                fill: "#ef4444", // Red color for highlight
                opacity: 0.8,
                stroke: "white",
                'stroke-width': 2
            });
            svg.appendChild(highlightCircle);
        }
    }
    
    // Function to handle clicking an individual note circle
    function handleNoteClick(noteName) {
        playNote(noteName, 0.5); 
        
        if (currentNoteHighlight === noteName) {
            currentNoteHighlight = null; // Turn off highlight
        } else {
            currentNoteHighlight = noteName; // Set new highlight
        }
        currentVoicingHighlight = null; // Clear chord voicing highlight
        
        // Re-draw the fretboard to apply new note highlighting
        drawFretboard(getScaleData().scaleNotes, getScaleData().root, getScaleData().intervals, getScaleData().choice);
    }

    // --- Fretboard Drawing Logic ---
    function drawFretboard(scaleNotes, root, intervals, choice) {
      const strings = ["E","B","G","D","A","E"]; 
      const notation = document.getElementById("notationSelect").value;
      const numFrets = 15;
      const width = 1000;
      const height = 180;
      const margin = { left: 40, top: 20, right: 20, bottom: 20 };
      const showDegrees = degreeToggle.checked;

      const fretboardDiv = document.getElementById("fretboard");
      fretboardDiv.innerHTML = "";

      const svg = createSVGElement("svg", {
          viewBox: `0 0 ${width} ${height}`,
          preserveAspectRatio: "xMinYMin meet",
          style: "width: 100%; min-width: 900px; height: auto;",
          role: "img", 
          'aria-label': `${root} ${choice} scale on guitar fretboard`
      });
      fretboardDiv.appendChild(svg);
      
      // Accessibility elements
      svg.appendChild(createSVGElement("title", { textContent: `${root} ${choice} Scale Fretboard Diagram` }));
      svg.appendChild(createSVGElement("desc", { textContent: `Shows the notes ${scaleNotes.join(', ')} across a ${numFrets}-fret guitar neck.` }));

      const drawingWidth = width - margin.left - margin.right;
      const fretSpacing = drawingWidth / (numFrets + 0.5);
      const stringSpacing = (height - margin.top - margin.bottom) / (strings.length - 1);
      const dotFrets = [3, 5, 7, 9, 12, 15];

      // Draw Fret Dots
      dotFrets.forEach(fret => {
        const cx = margin.left + fret * fretSpacing - fretSpacing / 2;
        const cy = height / 2;
        const attrs = { cx: cx, r: 5, class: "fret-dot" };

        if (fret === 12) {
          const offset = 25;
          svg.appendChild(createSVGElement("circle", { ...attrs, cy: cy - offset }));
          svg.appendChild(createSVGElement("circle", { ...attrs, cy: cy + offset }));
        } else {
          svg.appendChild(createSVGElement("circle", { ...attrs, cy: cy }));
        }
      });

      // Draw Frets and Strings
      for (let f = 0; f <= numFrets; f++) {
        const x = margin.left + f * fretSpacing;
        svg.appendChild(createSVGElement("line", { x1: x, y1: margin.top, x2: x, y2: height - margin.bottom, class: f === 0 ? "nut" : "fret" }));
      }

      for (let i = 0; i < strings.length; i++) {
        const y = margin.top + i * stringSpacing;
        svg.appendChild(createSVGElement("line", { x1: margin.left, y1: y, x2: width - margin.right, y2: y, class: "string" }));
      }

      // Draw Notes
      const rootIndex = getNoteIndex(root);
      for (let i = 0; i < strings.length; i++) { // String index (Top to Bottom)
        const openNote = strings[i];
        const openIdx = getNoteIndex(openNote);

        for (let fret = 0; fret <= numFrets; fret++) {
          const noteIdx = (openIdx + fret) % 12;
          const noteDisplay = getNoteName(noteIdx, notation);

          if (scaleNotes.includes(noteDisplay)) {
            let cx = fret === 0 ? margin.left - fretSpacing / 2 : margin.left + fret * fretSpacing - fretSpacing / 2;
            const cy = margin.top + i * stringSpacing;
            const r = 12;

            const isRoot = noteIdx === rootIndex;
            const isHighlighted = currentNoteHighlight === noteDisplay;
            
            let circleClass = isRoot ? "root-circle" : "note-circle";
            if (isHighlighted) {
                circleClass = "highlight-circle";
            }
            
            const circle = createSVGElement("circle", {
                cx: cx, cy: cy, r: r,
                class: circleClass,
                'data-note': noteDisplay,
                onclick: `handleNoteClick('${noteDisplay}')` // NEW: click handler
            });
            svg.appendChild(circle);
            
            const labelText = showDegrees 
                ? getIntervalNameFromScale(noteDisplay, root, intervals) 
                : noteDisplay;

            const text = createSVGElement("text", {
                x: cx, y: cy + 4,
                'text-anchor': "middle",
                'font-size': "10",
                'font-weight': "bold",
                class: "note-label"
            });
            text.textContent = labelText;
            svg.appendChild(text);
          }
        }
      }
      
      // If a chord voicing was previously highlighted, re-apply it after the scale notes are drawn
      if (currentVoicingHighlight) {
         highlightVoicing(currentVoicingHighlight);
      }
    }

    function getIntervalNameFromScale(note, root, intervals) {
        const rootIndex = getNoteIndex(root);
        const noteIndex = getNoteIndex(note);
        const semitoneOffset = (noteIndex - rootIndex + 12) % 12;
        
        for (let i = 0; i < intervals.length; i++) {
            if (intervalToSemitone(intervals[i]) === semitoneOffset) {
                return intervals[i] === '1' ? 'R' : intervals[i];
            }
        }
        return '';
    }

    function generateSemitoneMap(intervals) {
        const semitonesInScale = intervals.map(intervalToSemitone);
        let mapHtml = `<ul class="space-y-1">`;
        
        for (let i = 0; i < 12; i++) {
            const isInScale = semitonesInScale.includes(i);
            const style = isInScale ? 'text-emerald-700 font-semibold' : 'text-red-500 opacity-70';
            const semitoneName = getIntervalNameFromSemitone(i);
            
            mapHtml += `<li class="flex justify-between items-center ${style} border-b border-dashed border-gray-200 py-0.5">
                <span class="font-mono text-xs">Semitones: +${i}</span>
                <span class="text-sm">${semitoneName} ${isInScale ? '(In Scale)' : '(Out)'}</span>
            </li>`;
        }
        return mapHtml + `</ul>`;
    }

    // Function to get current scale data from state/inputs
    function getScaleData() {
        const type = typeSelect.value;
        const choice = choiceSelect.value;
        const root = rootSelect.value;
        const intervals = scaleTypes[type]?.[choice];
        const { scaleNotes } = buildScale(root, intervals);
        return { type, choice, root, intervals, scaleNotes };
    }
    
    // Scale Analysis Renderer
    function renderScaleAnalysis(type, choice, root, intervals) {
        const formula = intervals.join(" – ");
        const whTrail = calculateWHTrail(intervals);
        const derivation = getScaleDerivation(type, choice, root);
        
        scaleAnalysisDiv.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <div class="p-2 bg-white rounded-md border border-indigo-100">
                        <span class="text-xs font-semibold uppercase text-gray-500 block">Formula (Interval Degrees)</span>
                        <span class="font-mono text-sm">${formula}</span>
                    </div>
                    <div class="p-2 bg-white rounded-md border border-indigo-100">
                        <span class="text-xs font-semibold uppercase text-gray-500 block">Whole/Half Steps (W/H)</span>
                        <span class="font-mono text-sm">${whTrail}</span>
                    </div>
                    <div class="p-2 bg-white rounded-md border border-indigo-100">
                        <span class="text-xs font-semibold uppercase text-gray-500 block">Derivation/Example</span>
                        <p class="text-sm">${derivation}</p>
                    </div>
                </div>
                <div class="p-3 bg-white rounded-md border border-indigo-100">
                    <span class="text-xs font-semibold uppercase text-gray-500 block mb-2">Semitone Map (Relative to Root)</span>
                    ${generateSemitoneMap(intervals)}
                </div>
            </div>
        `;
    }

    // --- Chord Generation (UNCHANGED CORE LOGIC for 7-note scales) ---
    function getDiatonicChords(scaleNotes, root) {
        // ... (unchanged getDiatonicChords logic) ...
        if (scaleNotes.length !== 7) return null; 

        const notation = document.getElementById("notationSelect").value;
        const type = typeSelect.value;
        const choice = choiceSelect.value;
        const intervals = scaleTypes[type]?.[choice];
        const chords = [];

        for (let i = 0; i < scaleNotes.length; i++) {
            const chordRoot = scaleNotes[i];
            const notes = [
                scaleNotes[i], 
                scaleNotes[(i + 2) % 7], 
                scaleNotes[(i + 4) % 7], 
                scaleNotes[(i + 6) % 7]
            ];
            
            const r_idx = getNoteIndex(chordRoot);
            
            const intervalsInSemitones = notes.map(n => (getNoteIndex(n) - r_idx + 12) % 12);
            
            const thirdInterval = intervalsInSemitones[1];
            const fifthInterval = intervalsInSemitones[2];
            const seventhInterval = intervalsInSemitones[3];

            let quality = "7";
            let tensionNote = "";

            const isMinor = thirdInterval === 3;
            const isMajor = thirdInterval === 4;
            const isDim5 = fifthInterval === 6;
            const isAug5 = fifthInterval === 8;
            const isPerf5 = fifthInterval === 7;
            const isMinor7 = seventhInterval === 10;
            const isMajor7 = seventhInterval === 11;

            if (isMajor && isPerf5 && isMajor7) quality = "Maj7";
            else if (isMajor && isPerf5 && isMinor7) quality = "7";
            else if (isMinor && isPerf5 && isMinor7) quality = "m7";
            else if (isMinor && isDim5 && isMinor7) quality = "m7b5"; 
            else if (isMajor && isAug5 && isMajor7) quality = "Maj7(#5)";

            const scaleRootIdx = getNoteIndex(root);
            const relativeRootIdx = getNoteIndex(chordRoot);
            
            const tensionList = [];
            const tensionsMap = { 2: "9", 4: "11", 5: "#11", 9: "♭13", 11: "13", 1: "♭9", 3: "♭10" };

            intervals.forEach((intervalStr, index) => {
                const tensionSemitone = intervalToSemitone(intervalStr);
                const intervalFromChordRoot = (tensionSemitone - intervalsInSemitones[0] + 12) % 12;

                if (![0, 3, 7, 10, 11].includes(intervalFromChordRoot)) {
                    if (tensionsMap[intervalFromChordRoot]) {
                        tensionList.push(tensionsMap[intervalFromChordRoot]);
                    }
                }
            });

            tensionNote = [...new Set(tensionList)].join(", ");
            
            // Standardize quality based on tensions
            if (tensionNote.includes("#11") && quality.includes("Maj7")) quality = "Maj7#11"; 

            const baseQuality = quality.replace(/\(.*\)/g, '').trim(); 
            
            const voicingKey = voicingLibrary[quality] ? quality : 
                               voicingLibrary[baseQuality] ? baseQuality : 
                               "m7"; 
                               
            const voicings = voicingLibrary[voicingKey] || ["N/A"];
            const voicingDisplay = voicings.join(" | ");

            chords.push({
              degree: i + 1,
              root: chordRoot,
              quality: quality,
              notes: notes.join(", "),
              tension: tensionNote,
              voicings: voicingDisplay, 
            });
        }
        return chords;
    }

    function toRoman(num) {
        const numerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
        if (num > 0 && num <= numerals.length) {
            return numerals[num - 1];
        }
        return String(num); 
    }

    /* ---------- NEW RENDER FUNCTION (handles non-7 scales with suggestions) ---------- */
    function renderDiatonicChords(scaleNotes, root, scaleName = "") {
      const chords = (scaleNotes.length === 7) ? getDiatonicChords(scaleNotes, root) : null;

      chordOutputDiv.innerHTML = "";
      chordErrorP.classList.add('hidden');

      if (chords && chords.length > 0) {
        let html = `
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-gray-600 shadow-md rounded-lg overflow-hidden">
              <thead class="text-xs text-white uppercase bg-indigo-600">
                <tr>
                  <th class="px-3 py-3">Degree</th>
                  <th class="px-3 py-3">Chord Name</th>
                  <th class="px-3 py-3">Notes (R-3-5-7)</th>
                  <th class="px-3 py-3 hidden sm:table-cell">Characteristic Tensions</th>
                  <th class="px-3 py-3">Common Voicings (Click to Highlight)</th>
                </tr>
              </thead>
              <tbody>
        `;
        chords.forEach((c, i) => {
          const rowColor = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          
          const voicingList = c.voicings.split(' | ');
          const clickableVoicings = voicingList.map(v => 
            `<code onclick="highlightVoicing('${v.trim()}')" class="inline-block bg-gray-100 px-2 py-1 rounded mr-2 text-xs cursor-pointer hover:bg-indigo-200 transition duration-150">${v.trim()}</code>`
          ).join('');

          html += `
            <tr class="${rowColor} hover:bg-gray-100">
              <td class="px-3 py-2 font-bold text-gray-900">${toRoman(c.degree)}</td>
              <td class="px-3 py-2 text-indigo-700 font-extrabold">${c.root}${c.quality}</td>
              <td class="px-3 py-2 font-mono">${c.notes}</td>
              <td class="px-3 py-2 hidden sm:table-cell">${c.tension || 'None'}</td>
              <td class="px-3 py-2 text-xs">${clickableVoicings}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
        chordOutputDiv.innerHTML = html;
        return;
      }

      // Non-standard scales — show suggestions if available
      const suggestions = scaleChordSuggestions[scaleName] || [];

      if (suggestions.length === 0) {
        chordErrorP.textContent = "No pre-defined chord suggestions for this scale. This scale is highly non-standard for chord building.";
        chordErrorP.classList.remove('hidden');
        return;
      }

      // Build suggestions table
      let html = `
        <h3 class="text-lg font-semibold text-gray-700 mt-4 mb-3">Suggested Chords for ${scaleName}</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left text-gray-600 shadow-md rounded-lg overflow-hidden">
            <thead class="text-xs text-white uppercase bg-indigo-600">
              <tr>
                <th class="px-3 py-3">Suggested Chord</th>
                <th class="px-3 py-3">Idiomatic Use/Description</th>
                <th class="px-3 py-3">Common Voicings (Click to Highlight)</th>
              </tr>
            </thead>
            <tbody>
      `;

      suggestions.forEach((s, idx) => {
        const rowColor = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        const voicings = (s.voicings && s.voicings.length) 
            ? s.voicings.map(v => 
                `<code onclick="highlightVoicing('${v.trim()}')" class="inline-block bg-gray-100 px-2 py-1 rounded mr-2 text-xs cursor-pointer hover:bg-indigo-200 transition duration-150">${v.trim()}</code>`
            ).join('') 
            : '<em class="text-gray-400">none</em>';

        html += `
          <tr class="${rowColor} hover:bg-gray-100">
            <td class="px-3 py-2 font-extrabold text-indigo-700">${s.chord}</td>
            <td class="px-3 py-2">${s.label}</td>
            <td class="px-3 py-2">${voicings}</td>
          </tr>
        `;
      });

      html += `</tbody></table></div>`;
      chordOutputDiv.innerHTML = html;
    }


    // --- Initial Setup and Event Listeners ---
    populateRootSelect();
    typeSelect.value = 'mode';
    rootSelect.value = 'C';
    updateChoices();
    // Use an immediate function call to set the initial state without using .click() for cleaner load
    (() => {
        const { type, choice, root, intervals, scaleNotes } = getScaleData();
        document.getElementById("scaleNotes").innerHTML = `<strong>${root} ${choice}</strong> Notes: <span class="font-bold text-indigo-900">${scaleNotes.join(" – ")}</span>`;
        renderScaleAnalysis(type, choice, root, intervals); 
        drawFretboard(scaleNotes, root, intervals, choice); 
        renderDiatonicChords(scaleNotes, root, choice); 
    })();


    typeSelect.addEventListener("change", updateChoices);
    choiceSelect.addEventListener("change", () => showScaleBtn.click());
    rootSelect.addEventListener("change", () => showScaleBtn.click());
    degreeToggle.addEventListener("change", () => showScaleBtn.click());

    // NEW: Real-time notation update without re-triggering chord/scale analysis
    notationSelect.addEventListener("change", () => {
        const { type, choice, root, intervals, scaleNotes } = getScaleData();
        
        // 1. Update scale notes text with new notation
        document.getElementById("scaleNotes").innerHTML = `<strong>${root} ${choice}</strong> Notes: <span class="font-bold text-indigo-900">${scaleNotes.join(" – ")}</span>`;

        // 2. Re-draw fretboard (will use new notation and re-apply highlights)
        drawFretboard(scaleNotes, root, intervals, choice);
        
        // 3. Re-render chords to update note names in the table
        renderDiatonicChords(scaleNotes, root, choice);
    });


    playScaleBtn.addEventListener("click", () => {
        const { scaleNotes } = getScaleData();
        if (!scaleNotes.length) return;
        
        initAudioContext(); 
        playScale(scaleNotes);
    });

    showScaleBtn.addEventListener("click", () => {
      const { type, choice, root, intervals, scaleNotes } = getScaleData();

      if (!root || !choice || !intervals) {
        document.getElementById("scaleNotes").innerHTML = `<span class="text-red-600 font-bold">⚠️ Please select a root note and a scale/mode choice.</span>`;
        document.getElementById("fretboard").innerHTML = "";
        chordOutputDiv.innerHTML = "";
        chordErrorP.classList.add('hidden');
        scaleAnalysisDiv.innerHTML = ""; 
        return;
      }
      
      // Reset individual note highlight when a new scale is selected
      currentNoteHighlight = null;
      currentVoicingHighlight = null; 

      // FIX: Use <strong> instead of ** for bold HTML
      document.getElementById("scaleNotes").innerHTML =
        `<strong>${root} ${choice}</strong> Notes: <span class="font-bold text-indigo-900">${scaleNotes.join(" – ")}</span>`;
      
      renderScaleAnalysis(type, choice, root, intervals); 
      drawFretboard(scaleNotes, root, intervals, choice); 
      renderDiatonicChords(scaleNotes, root, choice); 
    });
  </script>
</body>
</html>
