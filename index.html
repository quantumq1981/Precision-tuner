<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melodic Minor Dominant Colors</title>
  <style>
    /* Global Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* General Styles */
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e4e4e4;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #00d4ff;
      font-size: 2rem;
    }

    .subtitle {
      text-align: center;
      color: #999;
      margin-bottom: 30px;
      font-size: 0.9rem;
    }

    /* Root Selector */
    .root-selector {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .root-selector h2 {
      margin-bottom: 15px;
      color: #00d4ff;
      font-size: 1.1rem;
    }

    .root-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .root-btn {
      padding: 12px 20px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 8px;
      color: #e4e4e4;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
      font-weight: 600;
    }

    .root-btn:hover {
      background: rgba(0,212,255,0.2);
      border-color: #00d4ff;
      transform: translateY(-2px);
    }

    .root-btn.active {
      background: #00d4ff;
      color: #1a1a2e;
      border-color: #00d4ff;
    }

    /* Color Cards Grid */
    .colors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Adjusted minmax for 5 cards */
      gap: 20px;
      margin-bottom: 30px;
    }

    .color-card {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .color-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    
    /* --- New Basic/Mixolydian Styling --- */
    .color-card.basic { border-color: rgba(0, 255, 127, 0.5); }
    .color-card.basic.active { background: rgba(0, 255, 127, 0.15); border-color: #00ff7f; }
    .color-card.basic .color-title { color: #00ff7f; }
    /* ------------------------------------- */

    .color-card.altered { border-color: rgba(255,71,87,0.5); }
    .color-card.altered.active { background: rgba(255,71,87,0.15); border-color: #ff4757; }

    .color-card.lydian { border-color: rgba(255,195,18,0.5); }
    .color-card.lydian.active { background: rgba(255,195,18,0.15); border-color: #ffc312; }

    .color-card.mixb6 { border-color: rgba(87,101,255,0.5); }
    .color-card.mixb6.active { background: rgba(87,101,255,0.15); border-color: #5765ff; }

    .color-card.sus { border-color: rgba(162,155,254,0.5); }
    .color-card.sus.active { background: rgba(162,155,254,0.15); border-color: #a29bfe; }

    .color-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .color-card.altered .color-title { color: #ff4757; }
    .color-card.lydian .color-title { color: #ffc312; }
    .color-card.mixb6 .color-title { color: #5765ff; }
    .color-card.sus .color-title { color: #a29bfe; }

    .parent-scale {
      font-size: 0.95rem;
      color: #aaa;
      margin-bottom: 12px;
    }

    .degrees {
      font-size: 1.05rem;
      color: #ddd;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .practice-tip {
      font-size: 0.85rem;
      color: #999;
      font-style: italic;
      line-height: 1.5;
    }

    /* Display Panel */
    .display-panel {
      background: rgba(0,212,255,0.1);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 12px;
      padding: 30px;
      margin-top: 30px;
      display: none;
    }

    .display-panel.show {
      display: block;
      animation: fadeIn 0.4s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .display-panel h3 {
      color: #00d4ff;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .scale-notes {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .note-box {
      background: rgba(255,255,255,0.1);
      padding: 15px 20px;
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: 600;
      border: 2px solid rgba(0,212,255,0.4);
    }

    .degree-analysis {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .degree-analysis h4 {
      color: #00d4ff;
      margin-bottom: 12px;
    }

    .practice-ideas {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }

    .practice-ideas h4 {
      color: #00d4ff;
      margin-bottom: 12px;
    }

    .practice-ideas ul {
      list-style: none;
      padding-left: 0;
    }

    .practice-ideas li {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
    }

    .practice-ideas li:before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: #00d4ff;
    }

    .warning {
      background: rgba(255,195,18,0.1);
      border-left: 4px solid #ffc312;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 25px;
      font-size: 0.9rem;
    }

    /* Fretboard Section */
    .fretboard-section {
      background: rgba(255,255,255,0.05);
      padding: 25px;
      border-radius: 8px;
      margin-top: 25px;
    }

    .fretboard-section h4 {
      color: #00d4ff;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .position-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .position-btn {
      padding: 10px 18px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 6px;
      color: #e4e4e4;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .position-btn:hover {
      background: rgba(0,212,255,0.2);
      border-color: #00d4ff;
    }

    .position-btn.active {
      background: #00d4ff;
      color: #1a1a2e;
      border-color: #00d4ff;
    }

    .fretboard {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      overflow-x: auto;
    }

    .fretboard-grid {
      display: inline-block;
      min-width: 600px;
    }

    .string {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      position: relative;
    }

    .string-label {
      width: 30px;
      font-size: 0.9rem;
      color: #888;
      font-weight: 600;
    }

    .fret {
      width: 50px;
      height: 35px;
      border-right: 1px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: rgba(0,0,0,0.2);
    }

    .fret.first {
      border-left: 3px solid #666;
    }

    .fret-marker {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.5); /* Added shadow for better pop */
    }

    .fret-marker.root {
      background: #ff4757;
      color: white;
      border: 2px solid #ff6b7a;
    }

    .fret-marker.scale {
      background: #00d4ff;
      color: #1a1a2e;
      border: 2px solid #33dfff;
    }

    .fret-marker.empty {
      opacity: 0;
    }

    .fret-numbers {
      display: flex;
      margin-left: 30px;
      margin-top: 5px;
      margin-bottom: 15px;
    }

    .fret-num {
      width: 50px;
      text-align: center;
      font-size: 0.8rem;
      color: #666;
      font-weight: 600;
    }

    .pattern-info {
      background: rgba(0,212,255,0.1);
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      border-left: 3px solid #00d4ff;
    }

    .pattern-info h5 {
      color: #00d4ff;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .pattern-info p {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .legend {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    .legend-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .legend-dot.root {
      background: #ff4757;
      border: 2px solid #ff6b7a;
    }

    .legend-dot.scale {
      background: #00d4ff;
      border: 2px solid #33dfff;
    }
    
    /* Controls and Toggles */
    .controls-bar {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toggle-btn {
      padding: 10px 18px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(0,212,255,0.3);
      border-radius: 6px;
      color: #e4e4e4;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .toggle-btn:hover {
      background: rgba(0,212,255,0.2);
      border-color: #00d4ff;
    }

    .toggle-btn.active {
      background: #00d4ff;
      color: #1a1a2e;
      border-color: #00d4ff;
    }

    /* Cycle Practice */
    .cycle-practice {
      background: rgba(255,195,18,0.1);
      border: 2px solid rgba(255,195,18,0.3);
      border-radius: 8px;
      padding: 20px;
      margin-top: 25px;
    }

    .cycle-practice h4 {
      color: #ffc312;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .cycle-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .cycle-btn {
      padding: 12px 24px;
      background: rgba(255,195,18,0.2);
      border: 2px solid #ffc312;
      border-radius: 6px;
      color: #ffc312;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
      font-weight: 700;
    }

    .cycle-btn:hover {
      background: rgba(255,195,18,0.3);
      transform: translateY(-2px);
    }

    .cycle-btn.active {
      background: #ffc312;
      color: #1a1a2e;
    }

    .cycle-display {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
    }

    .cycle-current {
      font-size: 2rem;
      font-weight: 700;
      color: #ffc312;
      min-width: 60px;
    }

    .cycle-info {
      flex: 1;
    }

    .cycle-info p {
      margin: 4px 0;
      font-size: 0.9rem;
      color: #ccc;
    }

    .interval-select {
      padding: 8px 12px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,195,18,0.3);
      border-radius: 6px;
      color: #e4e4e4;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    .interval-select:focus {
      outline: none;
      border-color: #ffc312;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #1a1a2e;
      border: 2px solid #00d4ff;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
    }

    .modal-content h3 {
      color: #00d4ff;
      margin-bottom: 20px;
    }

    .modal-content ul {
      list-style: none;
      padding: 0;
    }

    .modal-content li {
      padding: 12px;
      margin: 8px 0;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 3px solid #00d4ff;
    }

    .close-modal {
      margin-top: 20px;
      padding: 10px 20px;
      background: #00d4ff;
      border: none;
      border-radius: 6px;
      color: #1a1a2e;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .close-modal:hover {
        background: #33dfff;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .colors-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    
    @media (max-width: 768px) {
      .colors-grid {
        grid-template-columns: 1fr;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .fretboard {
        padding: 10px;
      }
      
      .fret {
        width: 40px;
        height: 30px;
      }
      
      .fret-num {
        width: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé∏ Melodic Minor Over Dominants</h1>
    <p class="subtitle">Parent scale relationships + fretboard positions for dominant chord colors</p>

    <div class="root-selector">
      <h2>Select Dominant Root (V7)</h2>
      <div class="root-buttons" id="rootButtons"></div>
    </div>

    <div class="colors-grid">
      <div class="color-card basic" data-color="mixolydian">
        <div class="color-title">Mixolydian (Standard)</div>
        <div class="parent-scale">Parent: Major scale from root</div>
        <div class="degrees">1, 2, 3, 4, 5, 6, ‚ô≠7</div>
        <div class="practice-tip">Default dominant scale. Great baseline for comparing colors</div>
      </div>
      
      <div class="color-card altered" data-color="altered">
        <div class="color-title">Altered</div>
        <div class="parent-scale">Parent: ¬Ω step up</div>
        <div class="degrees">1, ‚ô≠9, #9, 3, #11, ‚ô≠13, ‚ô≠7</div>
        <div class="practice-tip">Maximum tension for V‚ÜíI resolution. Target ‚ô≠9‚ÜíR, ‚ô≠13‚Üí5, #9‚Üí3</div>
      </div>
      
      <div class="color-card lydian" data-color="lydian">
        <div class="color-title">Lydian Dominant</div>
        <div class="parent-scale">Parent: up a 5th</div>
        <div class="degrees">1, 2, 3, #11, 5, 6, ‚ô≠7</div>
        <div class="practice-tip">Bright, open V sound. Avoids 4 when #11 is emphasized</div>
      </div>
      
      <div class="color-card mixb6" data-color="mixb6">
        <div class="color-title">Mixolydian ‚ô≠6</div>
        <div class="parent-scale">Parent: up a 4th</div>
        <div class="degrees">1, 2, 3, 4, 5, ‚ô≠6, ‚ô≠7</div>
        <div class="practice-tip">Dark dominant color. Great for V in minor keys, secondary dominants</div>
      </div>
      
      <div class="color-card sus" data-color="sus">
        <div class="color-title">V7sus(‚ô≠9)</div>
        <div class="parent-scale">Parent: down whole step</div>
        <div class="degrees">1, ‚ô≠9, 4, 5, 6, ‚ô≠7 (no 3rd)</div>
        <div class="practice-tip">For suspended dominants only. Dorian ‚ô≠2 sound without the 3rd</div>
      </div>
    </div>

    <div class="display-panel" id="displayPanel">
      <h3 id="panelTitle"></h3>
      
      <div class="warning" id="warningBox" style="display: none;"></div>
      
      <div class="scale-notes" id="scaleNotes"></div>
      
      <div class="degree-analysis">
        <h4>Scale Degrees Over Dominant</h4>
        <p id="degreeText"></p>
      </div>
      
      <div class="practice-ideas">
        <h4>In The Shed</h4>
        <ul id="practiceList"></ul>
      </div>
      
      <div class="fretboard-section">
        <h4>Fretboard Positions</h4>
        
        <div class="position-selector" id="positionSelector"></div>
        
        <div class="fretboard">
          <div class="fretboard-grid" id="fretboardGrid"></div>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-dot root"></div>
              <span>Root (dominant V7)</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot scale"></div>
              <span>Scale tones (from parent scale)</span>
            </div>
          </div>
        </div>
        
        <div class="pattern-info" id="patternInfo"></div>
      </div>
      
      <div class="controls-bar">
        <button class="toggle-btn" id="intervalsToggle">Show Intervals</button>
        <button class="toggle-btn" id="tipsToggle">Practice Tips</button>
      </div>
      
      <div class="cycle-practice">
        <h4>üîÑ Cycle of Fifths Practice Mode</h4>
        <div class="cycle-controls">
          <button class="cycle-btn" id="cycleStart">Start Auto-Cycle</button>
          <button class="cycle-btn" id="cycleNext">Next ‚ñ∂</button>
          <select class="interval-select" id="cycleInterval">
            <option value="5000">5 seconds</option>
            <option value="8000" selected>8 seconds</option>
            <option value="10000">10 seconds</option>
            <option value="15000">15 seconds</option>
            <option value="20000">20 seconds</option>
          </select>
        </div>
        <div class="cycle-display" id="cycleDisplay" style="display: none;">
          <div class="cycle-current" id="cycleCurrent">G7</div>
          <div class="cycle-info">
            <p><strong>Parent Scale:</strong> <span id="cycleParent"></span></p>
            <p><strong>Practice:</strong> Play the pattern in current position</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="tipsModal">
      <div class="modal-content">
        <h3>Fretboard Practice Tips</h3>
        <ul id="tipsList"></ul>
        <button class="close-modal" onclick="closeTipsModal()">Got it!</button>
      </div>
    </div>
  </div>

  <script>
    const notes = ['C', 'D‚ô≠', 'D', 'E‚ô≠', 'E', 'F', 'G‚ô≠', 'G', 'A‚ô≠', 'A', 'B‚ô≠', 'B'];
    const sharpNotes = ['C', 'C‚ôØ', 'D', 'D‚ôØ', 'E', 'F', 'F‚ôØ', 'G', 'G‚ôØ', 'A', 'A‚ôØ', 'B'];
    const standardTuning = ['E', 'A', 'D', 'G', 'B', 'E'];
    
    let currentRoot = 'G';
    let currentColor = null;
    let currentPosition = 0;
    // let showArpeggios = false; // Kept only for future expansion if you re-add the toggle
    let showIntervals = false;
    let cycleInterval = null;
    let cycleIndex = 0;
    
    const cycleOfFifths = ['C', 'G', 'D', 'A', 'E', 'B', 'G‚ô≠', 'D‚ô≠', 'A‚ô≠', 'E‚ô≠', 'B‚ô≠', 'F'];
    
    // Updated with Mixolydian tips
    const practiceTips = {
      mixolydian: [
        'Default dominant sound ‚Äî start here when unsure',
        'Emphasize the 6th and ‚ô≠7th in your lines',
        'Target 3‚Üí1 and 6‚Üí5 resolutions',
        'Great for blues, rock, and functional V chords',
        'Add chromatic passing tones for bebop flavor'
      ],
      altered: [
        'Start with R-3-‚ô≠13-‚ô≠9 arpeggio to outline the altered sound',
        'Practice chromatic approach: play #9 to resolve to 3',
        'Target ‚ô≠13 descending to 5 of the I chord',
        'Use ‚ô≠9-R motion for strong resolution',
        'Combine ‚ô≠9 and #9 in the same phrase for maximum tension'
      ],
      lydian: [
        'Emphasize the #11 - it\'s the signature sound',
        'Play major triad from the 3rd (E over G7 = G Lydian Dom)',
        'Avoid the 4 - the #11 replaces it',
        'Use ascending 6-‚ô≠7-R motion for brightness',
        'Great for vamps - exploit the major 6th interval'
      ],
      mixb6: [
        'The ‚ô≠6 creates a darker, more mysterious dominant',
        'Works perfectly as V7 in minor keys',
        'Practice ‚ô≠6-5 half-step resolution',
        'Combine with ‚ô≠9 for additional darkness',
        'Use on secondary dominants for modal color'
      ],
      sus: [
        'Omit the 3rd entirely - this is a suspended sound',
        'Focus on 4-5 resolution when moving to regular dominant',
        'The ‚ô≠9 adds tension without committing to major/minor',
        'Practice 4-sus shapes with ‚ô≠9 on top',
        'Resolve to 3 at the cadence for maximum release'
      ]
    };
    
    // Updated with new mixolydian entry and type property
    const colors = {
      mixolydian: {
        offset: 0,
        degrees: '1, 2, 3, 4, 5, 6, ‚ô≠7',
        practice: [
          'Default dominant sound ‚Äî start here when unsure',
          'Emphasize 3, 6, ‚ô≠7 in bebop lines',
          'Target 3‚Üí1 and 6‚Üí5 resolutions',
          'Great for blues, rock, and functional V chords',
          'Add chromatic passing tones for bebop flavor'
        ],
        warning: null,
        type: 'major'
      },
      altered: {
        offset: 1,
        degrees: '1, ‚ô≠9, #9, 3, #11, ‚ô≠13, ‚ô≠7',
        practice: [
          'Target ‚ô≠9‚ÜíR resolution in ii-V-I progressions',
          'Use ‚ô≠13‚Üí5 descent over V',
          'Stack #9 and 3 for intense color (sounds like ‚ô≠3 + 3)',
          'Practice arpeggios: R-3-‚ô≠13-‚ô≠9, R-#11-‚ô≠7-#9'
        ],
        warning: null
      },
      lydian: {
        offset: 7,
        degrees: '1, 2, 3, #11, 5, 6, ‚ô≠7',
        practice: [
          'Emphasize #11 to avoid sounding like IV',
          'Play triads from 3rd: E major over G7 = G Lydian Dom',
          'Use in place of Mixolydian for brighter V sound',
          'Great for jazz-funk, fusion vamps on static V'
        ],
        warning: null
      },
      mixb6: {
        offset: 5,
        degrees: '1, 2, 3, 4, 5, ‚ô≠6, ‚ô≠7',
        practice: [
          'Darker alternative to Mixolydian',
          'Perfect for V7 in minor keys (V of i)',
          'Use on secondary dominants for modal color',
          'Pairs well with ‚ô≠9 and ‚ô≠13 alterations'
        ],
        warning: null
      },
      sus: {
        offset: -2,
        degrees: '1, ‚ô≠9, 4, 5, 6, ‚ô≠7 (omit 3)',
        practice: [
          'Use ONLY on suspended dominants (no major 3rd)',
          'Dorian ‚ô≠2 sound: F melodic minor over G7sus',
          'Comp without the 3rd to maintain sus quality',
          'Resolve sus‚Üí3 at cadence for release'
        ],
        warning: '‚ö†Ô∏è This is for V7sus(‚ô≠9) only ‚Äî not for regular dominant 7th chords with a major 3rd. If you\'re playing a plain G7, use one of the other four colors.'
      }
    };
    
    const positions = [
      { name: 'Pos 1 (Open/Low)', startFret: 0, endFret: 4, desc: 'Open position patterns. Root on 6th string, extends to 4th fret.' },
      { name: 'Pos 2', startFret: 2, endFret: 6, desc: '2nd-5th position. Root typically on 5th or 6th string, middle of neck access.' },
      { name: 'Pos 3', startFret: 5, endFret: 9, desc: '5th-9th position. Root on 5th or 4th string. Strong box pattern.' },
      { name: 'Pos 4', startFret: 7, endFret: 11, desc: '7th-11th position. Root on 4th or 3rd string. Upper extension range.' },
      { name: 'Pos 5', startFret: 10, endFret: 14, desc: '10th-14th position. Root on 3rd string, upper register melodic work.' },
      { name: 'Pos 6 (High)', startFret: 12, endFret: 16, desc: 'Octave position (12th fret+). Mirrors open position higher.' },
      { name: 'Full Neck', startFret: 0, endFret: 15, desc: 'Complete fretboard view showing all scale tone locations.' }
    ];
    
    function getNoteIndex(note) {
      let idx = notes.indexOf(note);
      if (idx === -1) idx = sharpNotes.indexOf(note);
      return idx;
    }
    
    function getNoteName(index) {
      return notes[index % 12];
    }
    
    // MODIFIED: getMelodicMinor now handles Major scale type for Mixolydian
    function getMelodicMinor(root, offset, type = 'melodic') {
      const rootIndex = getNoteIndex(root);
      const parentIndex = (rootIndex + offset + 12) % 12;
      const parentRoot = getNoteName(parentIndex);
      
      let scale = [];
      let intervals;

      if (type === 'major') {
        // Major Scale Intervals: R, M2, M3, P4, P5, M6, M7
        // Mixolydian is the 5th mode, so we use the Major Scale of the parent root
        intervals = [0, 2, 4, 5, 7, 9, 11]; // Major scale intervals
      } else {
        // Melodic Minor Intervals: R, M2, m3, P4, P5, M6, M7
        intervals = [0, 2, 3, 5, 7, 9, 11]; // Melodic minor intervals
      }

      for (let interval of intervals) {
        const noteIndex = (parentIndex + interval + 12) % 12; // Ensure index is non-negative
        scale.push(getNoteName(noteIndex));
      }
      
      return { parent: parentRoot, notes: scale, rootIndex: rootIndex }; // The rootIndex is the V7 root, not the parent scale root
    }
    
    function getFretNote(stringNote, fret) {
      const stringIndex = getNoteIndex(stringNote);
      return getNoteName(stringIndex + fret);
    }
    
    function drawFretboard(scaleData, position, colorKey) {
      const grid = document.getElementById('fretboardGrid');
      grid.innerHTML = '';
      
      const startFret = position.startFret;
      const endFret = position.endFret;
      // const fretCount = endFret - startFret + 1;
      
      const fretNumbers = document.createElement('div');
      fretNumbers.className = 'fret-numbers';
      for (let f = startFret; f <= endFret; f++) {
        const num = document.createElement('div');
        num.className = 'fret-num';
        num.textContent = f === 0 ? 'O' : f;
        fretNumbers.appendChild(num);
      }
      grid.appendChild(fretNumbers);
      
      // Removed arpeggio logic as toggle was simplified, but leaving the scale tone mapping
      
      for (let s = 0; s < 6; s++) {
        const stringDiv = document.createElement('div');
        stringDiv.className = 'string';
        
        const label = document.createElement('div');
        label.className = 'string-label';
        label.textContent = standardTuning[s];
        stringDiv.appendChild(label);
        
        for (let f = startFret; f <= endFret; f++) {
          const fretDiv = document.createElement('div');
          fretDiv.className = 'fret';
          if (f === startFret) fretDiv.classList.add('first');
          
          const fretNote = getFretNote(standardTuning[s], f);
          const noteIndex = getNoteIndex(fretNote);
          
          const marker = document.createElement('div');
          marker.className = 'fret-marker';
          
          const isV7Root = getNoteIndex(currentRoot) === noteIndex;
          const isScaleTone = scaleData.notes.includes(fretNote);
          
          if (isV7Root) {
            marker.classList.add('root');
            marker.textContent = showIntervals ? 'R' : currentRoot;
          } else if (isScaleTone) {
            marker.classList.add('scale');
            const degreeIdx = scaleData.notes.indexOf(fretNote) + 1;
            // The degree calculation should reflect the mode's structure
            marker.textContent = showIntervals ? getDegreeLabel(colorKey, fretNote) : degreeIdx; 
          } else {
            marker.classList.add('empty');
          }
          
          fretDiv.appendChild(marker);
          stringDiv.appendChild(fretDiv);
        }
        
        grid.appendChild(stringDiv);
      }
    }
    
    function getDegreeLabel(colorKey, note) {
      const color = colors[colorKey];
      const rootIndex = getNoteIndex(currentRoot);
      const noteIndex = getNoteIndex(note);
      const semitones = (noteIndex - rootIndex + 12) % 12;
      
      // Labels for the Dominant V7 root
      const labels = ['R', '‚ô≠9', '9', '‚ô≠3/3', '4', '#11/‚ô≠5', '5', '‚ô≠6', '6', '‚ô≠7', '7', '‚ô≠7']; // Simplified common labels
      
      // More accurate labels based on the specific mode's degrees property
      const modeLabels = color.degrees.replace(/[1,]/g, '').trim().split(', ');
      
      let label = '';
      if (semitones === 0) return 'R';
      
      // Match the semitones to the defined degrees for each mode (simplified)
      const intervalMap = {
          0: 'R', 1: '‚ô≠9', 2: '9', 3: 'm3/‚ô≠3', 4: '3', 5: '4', 6: '#11/‚ô≠5', 7: '5', 8: '‚ô≠6', 9: '6', 10: '‚ô≠7', 11: '7'
      };
      
      // Let's rely on the simple, correct labels for the dominant context
      if (semitones === 1 && modeLabels.includes('‚ô≠9')) label = '‚ô≠9';
      else if (semitones === 2) label = (modeLabels.includes('‚ô≠9') && modeLabels.includes('#9')) ? '#9' : '9'; // Check for altered's #9
      else if (semitones === 3) label = 'm3/‚ô≠3'; // Should not be in a dominant scale
      else if (semitones === 4) label = '3';
      else if (semitones === 5) label = (modeLabels.includes('4')) ? '4' : '#11'; // Lydian Dominant uses #11
      else if (semitones === 6) label = '‚ô≠5/#11'; 
      else if (semitones === 7) label = '5';
      else if (semitones === 8) label = (modeLabels.includes('‚ô≠6')) ? '‚ô≠6' : '‚ô≠13'; // Mix‚ô≠6/Altered uses ‚ô≠6/‚ô≠13
      else if (semitones === 9) label = '6';
      else if (semitones === 10) label = '‚ô≠7';
      else if (semitones === 11) label = '7'; // Should not be in a Mixolydian-derived scale
      
      return label || intervalMap[semitones] || '?'; // Fallback
    }
    
    function initRootButtons() {
      const container = document.getElementById('rootButtons');
      notes.forEach(note => {
        const btn = document.createElement('button');
        btn.className = 'root-btn';
        btn.textContent = note + '7';
        if (note === currentRoot) btn.classList.add('active');
        btn.onclick = () => selectRoot(note, btn);
        container.appendChild(btn);
      });
    }
    
    function selectRoot(root, btn) {
      currentRoot = root;
      document.querySelectorAll('.root-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      if (currentColor) {
        showColorInfo(currentColor);
      }
    }
    
    function initPositionButtons() {
      const container = document.getElementById('positionSelector');
      container.innerHTML = '';
      
      positions.forEach((pos, idx) => {
        const btn = document.createElement('button');
        btn.className = 'position-btn';
        btn.textContent = pos.name;
        if (idx === currentPosition) btn.classList.add('active');
        btn.onclick = () => selectPosition(idx, btn);
        container.appendChild(btn);
      });
    }
    
    // MODIFIED: Pass type to getMelodicMinor
    function selectPosition(idx, btn) {
      currentPosition = idx;
      document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      if (currentColor) {
        const color = colors[currentColor];
        const scale = getMelodicMinor(currentRoot, color.offset, color.type || 'melodic');
        drawFretboard(scale, positions[idx], currentColor);
        updatePatternInfo(positions[idx]);
      }
    }
    
    function updatePatternInfo(position) {
      const info = document.getElementById('patternInfo');
      info.innerHTML = `
        <h5>${position.name}</h5>
        <p>${position.desc}</p>
      `;
    }
    
    document.querySelectorAll('.color-card').forEach(card => {
      card.onclick = () => {
        document.querySelectorAll('.color-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        showColorInfo(card.dataset.color);
      };
    });
    
    // MODIFIED: Pass type to getMelodicMinor
    function showColorInfo(colorKey) {
      currentColor = colorKey;
      const color = colors[colorKey];
      const scale = getMelodicMinor(currentRoot, color.offset, color.type || 'melodic');
      
      const panel = document.getElementById('displayPanel');
      const title = document.getElementById('panelTitle');
      const scaleNotes = document.getElementById('scaleNotes');
      const degreeText = document.getElementById('degreeText');
      const practiceList = document.getElementById('practiceList');
      const warningBox = document.getElementById('warningBox');
      
      const colorNames = {
        mixolydian: 'Mixolydian (Standard)',
        altered: 'Altered',
        lydian: 'Lydian Dominant',
        mixb6: 'Mixolydian ‚ô≠6',
        sus: 'V7sus(‚ô≠9)'
      };
      
      let parentDesc = scale.parent + (color.type === 'major' ? ' Major Scale' : ' Melodic Minor');
      title.textContent = `${currentRoot}7 ${colorNames[colorKey]} ‚Üí ${parentDesc}`;
      
      scaleNotes.innerHTML = '';
      scale.notes.forEach(note => {
        const noteBox = document.createElement('div');
        noteBox.className = 'note-box';
        noteBox.textContent = note;
        scaleNotes.appendChild(noteBox);
      });
      
      degreeText.textContent = color.degrees;
      
      practiceList.innerHTML = '';
      color.practice.forEach(tip => {
        const li = document.createElement('li');
        li.textContent = tip;
        practiceList.appendChild(li);
      });
      
      if (color.warning) {
        warningBox.textContent = color.warning;
        warningBox.style.display = 'block';
      } else {
        warningBox.style.display = 'none';
      }
      
      initPositionButtons();
      drawFretboard(scale, positions[currentPosition], currentColor);
      updatePatternInfo(positions[currentPosition]);
      
      panel.classList.add('show');
    }
    
    function initControls() {
      /* Re-add this block if you re-implement arpeggio logic
      document.getElementById('arpeggioToggle').onclick = () => {
        showArpeggios = !showArpeggios;
        document.getElementById('arpeggioToggle').classList.toggle('active');
        if (currentColor) {
          const color = colors[currentColor];
          const scale = getMelodicMinor(currentRoot, color.offset, color.type || 'melodic');
          drawFretboard(scale, positions[currentPosition]);
        }
      };
      */
      
      document.getElementById('intervalsToggle').onclick = () => {
        showIntervals = !showIntervals;
        document.getElementById('intervalsToggle').classList.toggle('active');
        if (currentColor) {
          const color = colors[currentColor];
          // MODIFIED: Pass type to getMelodicMinor
          const scale = getMelodicMinor(currentRoot, color.offset, color.type || 'melodic');
          drawFretboard(scale, positions[currentPosition], currentColor);
        }
      };
      
      document.getElementById('tipsToggle').onclick = () => {
        if (currentColor) {
          showTipsModal(currentColor);
        }
      };
      
      document.getElementById('cycleStart').onclick = () => {
        toggleCycle();
      };
      
      document.getElementById('cycleNext').onclick = () => {
        advanceCycle();
      };
      
      // Ensure the cycle starts with a selected color
      if (document.querySelector('.color-card.active')) {
          currentColor = document.querySelector('.color-card.active').dataset.color;
      } else {
          // Default to Mixolydian if none selected to ensure cycle works
          currentColor = 'mixolydian';
          document.querySelector('[data-color="mixolydian"]').classList.add('active');
      }
    }
    
    function toggleCycle() {
      const btn = document.getElementById('cycleStart');
      const display = document.getElementById('cycleDisplay');
      
      if (!currentColor) {
        alert('Please select a dominant color (e.g., Mixolydian, Altered) before starting the cycle.');
        return;
      }
      
      if (cycleInterval) {
        clearInterval(cycleInterval);
        cycleInterval = null;
        btn.textContent = 'Start Auto-Cycle';
        btn.classList.remove('active');
      } else {
        const interval = parseInt(document.getElementById('cycleInterval').value);
        cycleInterval = setInterval(advanceCycle, interval);
        btn.textContent = 'Stop';
        btn.classList.add('active');
        display.style.display = 'flex';
        // Start immediately by calling once
        advanceCycle();
      }
    }
    
    // MODIFIED: Pass type to getMelodicMinor
    function advanceCycle() {
      const display = document.getElementById('cycleDisplay');
      display.style.display = 'flex';
      
      const newRoot = cycleOfFifths[cycleIndex];
      cycleIndex = (cycleIndex + 1) % cycleOfFifths.length;
      
      const rootBtn = Array.from(document.querySelectorAll('.root-btn'))
        .find(btn => btn.textContent === newRoot + '7');
      if (rootBtn) {
        selectRoot(newRoot, rootBtn); // This will call showColorInfo, which updates everything
      }
      
      document.getElementById('cycleCurrent').textContent = newRoot + '7';
      
      if (currentColor) {
        const color = colors[currentColor];
        const scale = getMelodicMinor(newRoot, color.offset, color.type || 'melodic');
        let parentDesc = scale.parent + (color.type === 'major' ? ' Major Scale' : ' Melodic Minor');
        document.getElementById('cycleParent').textContent = parentDesc;
        // Re-render info for the new root in the cycle
        showColorInfo(currentColor); 
      }
    }
    
    function showTipsModal(colorKey) {
      const modal = document.getElementById('tipsModal');
      const tipsList = document.getElementById('tipsList');
      
      tipsList.innerHTML = '';
      practiceTips[colorKey].forEach(tip => {
        const li = document.createElement('li');
        li.textContent = tip;
        tipsList.appendChild(li);
      });
      
      modal.classList.add('show');
    }
    
    function closeTipsModal() {
      document.getElementById('tipsModal').classList.remove('show');
    }
    
    document.getElementById('tipsModal').onclick = (e) => {
      if (e.target.id === 'tipsModal' || e.target.classList.contains('close-modal')) {
        closeTipsModal();
      }
    };
    
    initRootButtons();
    initControls();
    // Default to the new Mixolydian mode on load
    document.querySelector('[data-color="mixolydian"]').click();
  </script>

</body>
</html>
